{% extends "base.html" %}

{% block content %}
<div class="alert alert-info alert-dismissible fade show fade-in" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Welcome back, {{ current_user.name }}!</strong> Click the "Scan QR Code" button to start your camera and mark attendance.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-user-graduate me-3"></i>Student Dashboard
                </h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-user me-2"></i>{{ current_user.name }} | 
                    <i class="fas fa-id-card me-2"></i>{{ current_user.registration_number }}
                </p>
            </div>
            <div class="text-end">
                <span class="badge bg-success fs-6">
                    <i class="fas fa-circle me-1"></i>Online
                </span>
            </div>
        </div>
        <div class="card student-info-card slide-in">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="card-title">
                            <i class="fas fa-user-circle me-2"></i>Personal Information
                        </h5>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong><i class="fas fa-user me-2"></i>Name:</strong></td>
                                <td>{{ current_user.name }}</td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-envelope me-2"></i>Email:</strong></td>
                                <td>{{ current_user.email }}</td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-id-card me-2"></i>Registration No:</strong></td>
                                <td>{{ current_user.registration_number }}</td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-calendar me-2"></i>Year:</strong></td>
                                <td>{{ current_user.year }}</td>
                            </tr>
                            <tr>
                                <td><strong><i class="fas fa-layer-group me-2"></i>Division:</strong></td>
                                <td>{{ current_user.division }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5 class="card-title">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h5>
                        <div class="d-grid gap-3 quick-actions">
                            <a href="{{ url_for('student.available_subjects') }}" class="btn btn-primary">
                                <i class="fas fa-book"></i> Browse Subjects
                            </a>
                            <a href="{{ url_for('student.view_attendance') }}" class="btn btn-info">
                                <i class="fas fa-chart-bar"></i> View Attendance
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card slide-in" style="animation-delay: 0.2s;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-qrcode me-2"></i>QR Scanner
                </h5>
            </div>
            <div class="card-body">
                <!-- Initial Scan Button -->
                <div id="scan-button-container" class="text-center">
                    <div class="mb-4">
                        <i class="fas fa-qrcode" style="font-size: 4rem; color: var(--primary-color);"></i>
                    </div>
                    <button id="start-scan-btn" class="btn btn-primary btn-lg">
                        <i class="fas fa-qrcode"></i> Scan QR Code
                    </button>
                    <p class="text-muted mt-3">
                        <i class="fas fa-info-circle me-1"></i> Click to start camera and scan QR code for attendance
                    </p>
                    <small class="text-muted">
                        <i class="fas fa-shield-alt me-1"></i> Camera access will be requested
                    </small>
                </div>
                
                <!-- Camera Container (Hidden Initially) -->
                <div id="camera-container" style="display: none;">
                    <div class="text-center mb-3">
                        <small class="text-muted">
                            <i class="fas fa-camera me-1"></i> Camera access required for QR scanning
                        </small>
                    </div>
                    <div id="reader"></div>
                    <div id="camera-loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading camera...</span>
                        </div>
                        <p class="mt-2 text-muted">Initializing camera...</p>
                    </div>
                    <div class="text-center mt-3">
                        <button id="stop-scan-btn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times me-1"></i> Stop Scanning
                        </button>
                    </div>
                </div>
                
                <div id="result" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col">
        <div class="card slide-in" style="animation-delay: 0.4s;">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-book me-2"></i>My Subjects
                </h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><i class="fas fa-book me-1"></i>Subject Name</th>
                                <th><i class="fas fa-calendar me-1"></i>Year</th>
                                <th><i class="fas fa-layer-group me-1"></i>Division</th>
                                <th><i class="fas fa-hashtag me-1"></i>Roll Number</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for enrollment in enrollments %}
                            <tr>
                                <td>
                                    <i class="fas fa-book text-primary me-2"></i>
                                    {{ enrollment.subject.name }}
                                </td>
                                <td>{{ enrollment.subject.year }}</td>
                                <td>{{ enrollment.subject.division }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ enrollment.roll_number }}</span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-book-open mb-3" style="font-size: 3rem;"></i>
                                        <h5 class="mt-3">No Subjects Enrolled</h5>
                                        <p class="mb-3">You haven't enrolled in any subjects yet.</p>
                                        <a href="{{ url_for('student.available_subjects') }}" class="btn btn-primary">
                                            <i class="fas fa-search me-1"></i>Browse available subjects
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let html5QrcodeScanner;

function onScanSuccess(decodedText, decodedResult) {
    try {
        const data = JSON.parse(decodedText);
        document.getElementById('result').innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Processing...</div>';
        
        fetch('/student/mark-attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ qr_data: decodedText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('result').innerHTML = 
                    `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>${data.error}</div>`;
            } else {
                let classTimeText = '';
                if (data.class_start_time !== 'N/A' && data.class_end_time !== 'N/A') {
                    classTimeText = `<br><small><i class="fas fa-clock me-1"></i>Class Time: ${data.class_start_time} - ${data.class_end_time}</small>`;
                }
                
                document.getElementById('result').innerHTML = 
                    `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i><strong>${data.message}</strong>${classTimeText}
                        <br><button class="btn btn-sm btn-outline-success mt-2" onclick="startScanning()">
                            <i class="fas fa-redo me-1"></i> Scan Another QR Code
                        </button>
                    </div>`;
                
                // Stop scanner after successful scan
                stopScanning();
            }
        })
        .catch(error => {
            document.getElementById('result').innerHTML = 
                `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${error.message}</div>`;
        });
    } catch (e) {
        document.getElementById('result').innerHTML = 
            '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Invalid QR code format</div>';
    }
}

function onScanFailure(error) {
    // Handle scan failure, usually better to just ignore
}

function startScanning() {
    // Hide scan button and show camera
    document.getElementById('scan-button-container').style.display = 'none';
    document.getElementById('camera-container').style.display = 'block';
    document.getElementById('result').innerHTML = '';
    
    // Initialize scanner
    setTimeout(() => {
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            }
        );
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        
        // Hide loading indicator after camera is initialized
        setTimeout(() => {
            const loadingElement = document.getElementById('camera-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }, 2000);
    }, 500);
}

function stopScanning() {
    // Stop scanner
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
    }
    
    // Show scan button and hide camera
    document.getElementById('scan-button-container').style.display = 'block';
    document.getElementById('camera-container').style.display = 'none';
    
    // Show loading indicator again for next use
    const loadingElement = document.getElementById('camera-loading');
    if (loadingElement) {
        loadingElement.style.display = 'block';
    }
}

// Initialize event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add click event to start scan button
    document.getElementById('start-scan-btn').addEventListener('click', startScanning);
    
    // Add click event to stop scan button
    document.getElementById('stop-scan-btn').addEventListener('click', stopScanning);
});
</script>
{% endblock %}
